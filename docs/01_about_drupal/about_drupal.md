---
marp: true
theme: gaia
_class: invert
---

<!-- _class: lead -->
# Drupalとは

---

Drupalは、Webベースのコンテンツ管理システム（CMS）です。CMSとしてすぐに利用できるように基本的な機能が提供されていますが、開発者を念頭に置いて設計されています。

このセクションでは、Drupal 8で開発を行うための用語、ツール、およびプロセスを紹介します。以降の章ではコードの実装に焦点を当てますが、この章ではDrupalのアーキテクチャや概念に焦点を当てています。

---

## Drupalとは

Drupalは伝統的なWebベースのCMSに必要な標準機能をすべて備えています。

- 訪問者はサイト上の公開情報の表示、メニューによるのナビゲーション、リストの表示、個々のページなどを行うことができます。
- ユーザーはアカウントを作成してコメントを残すことができます。
- 管理者はサイトの設定やアカウントの権限の制御ができます。
- 編集者はページを作成・プレビューし、準備ができたらコンテンツを公開することができます。
- いくつかの組み込みテーマにより、サイトのデザインも簡単に変更できます。

---

Drupal 8はこれらを改良し、より強力な機能をいくつか導入しました。たとえば、高度な多言語サポート、コンテンツモデレーション、レイアウト構築、REST APIなど。これら以外にもその他の多くの機能がすぐに使用できるようになりました。

---

## Drupal 8での開発

Drupal 8はデフォルトでも多くの機能を提供しますが、全てのユーザーのニーズを満たすわけではありません。そのために、Drupalの機能はモジュール、テーマ、インストールプロファイルで拡張することができます。

[drupal.org](http://drupal.org) を見ると、数千もの新しい機能を提供するモジュールや、サイトのデザインを変更するテーマを見つけることができます。

---

モジュールとテーマを利用してDrupalを拡張できる柔軟なアーキテクチャにより、Drupalは単なるCMSではなく、「特定のニーズと機能要件に合わせて再編成できる `コンテンツ管理フレームワーク(CMF)` である」と言われるようになりました。

例えば、
- 認証にディレクトリサーバーを利用したい
- データをcsvでエクスポートしたい
- SNSへのシェアボタンを追加したい

などのニーズをdrupal.orgで公開されているモジュールを導入することで満たすことができます。

---

一方で、先のような一般的なニーズではなく
- 自社で開発したプロプライエタリなシステムと連携したい
- ビジネス特有の業務プロセスを補助するためのワークフローを提供したい
  
など、特殊なビジネス要件を解決するためにDrupalをカスタマイズするにはどうすれば良いでしょうか？

---

おそらく、その問題を完璧に解決してくれるモジュールは存在しません。
その代わりに、少しのコードを書くことで問題を解決することができます。

この点が本コンテンツの主題であり、あなた自身の目標を達成するための知識とツールを提供することを目的としています。

---

要約すると、本コンテンツの目的は「Drupalモジュール開発のために必要な知識とツールを可能な限り迅速に提供すること」です。

本章を含め6章までを順に進めることで、Drupalのモジュール開発に必要な要素を理解していく形になっています。

7章以降では、特定の問題を解決するためのレシピ的なテクニックを紹介します。6章まで一旦読み終えてから、必要に応じて参照してください。

---

ほとんどの章では、これから説明する概念を実装する方法を示すように設計されたサンプルコードを提供します。

Drupalコーディング規約に従い、Drupal開発コンテキスト内でコードを記述する正しい方法を説明するために、Drupalデザインパターンを活用します。

それでは、Drupalをよりよく理解するために、いくつかの予備知識を学ぶことから始めましょう。

---

<!-- _class: lead -->
## Drupalが利用するテクノロジー

---

## PHP

Drupal [PHP](https://www.php.net/) で実装されており、本コンテツ作成時点の最新バージョンであるDrupal 8.8では[PHP 7.2の利用が推奨されています](https://www.drupal.org/project/drupal/releases/8.8.0)。

[PHPのサポートサイクル](https://www.php.net/supported-versions.php) を意識しながら、ビジネスの要件に合わせて最適なバージョンを選択してください。

---

PHPのスタイルに関してDrupal 7までと比較して非常に重要な変更は、オブジェクト指向のコードとデザインパターンの利用です。

残念ながら、まだ多くの手続き型の実装がDrupal 8のコードベース全体に残っていますが、Symfonyコンポーネントなど多くの優れた外部ライブラリを利用することで、Drupalのコードは非常にモダンになりました。

そのため、Drupal 8の開発を行う場合は、PHPに関連したオブジェクト指向プログラミングの基本的な知識があることも非常に重要です。

---

Drupal 7以前で開発経験がある方は、内部設計やコードの実装はほぼ置き換わっていることを念頭に置いておきましょう。
```bash
$ git clone https://github.com/drupal/drupal.git
$ cd drupal
$ git diff --stat origin/7.x...origin/8.0.x|tail -n 1
 13327 files changed, 1429223 insertions(+), 287597 deletions(-)
```

---

### データベース

Drupal 8はいくつかの代表的なデータベースをサポートしています。
詳細は、 [Database server](https://www.drupal.org/docs/8/system-requirements/database-server) を参照してください。

Drupalコアがデータベースにアクセスする際は、PHP言語の抽象化レイヤーである[PDO](https://www.php.net/manual/en/book.pdo.php) を利用します。
また、開発者向けに[Dynamic Queries](https://www.drupal.org/docs/8/api/database-api/dynamic-queries) と呼ばれる更にハイレベルのAPIが提供されています。

このAPIについては5章で別途解説します。

---

他のモダンなフレームワークで開発する場合と同様に、Drupalの開発において直接SQLを書くケースはほぼありません。
(頻繁にあるようなら実装の妥当性を疑いましょう！)

しかし、ある程度規模の大きいシステムになるとパフォーマンスのチューニング等が必要になるケースもあります。

そのため、基本的なSQL構文の理解や「このAPIを使うと内部的にはこんなSQLが実行されるはずだ」といった内部構造の把握と理解は依然としてとても重要になります。

---

### Webサーバー

DrupalはApache,nginx,IIS,Lighttpd)などの主要なWebサーバー上で動作します。
詳細は [Web Server](https://www.drupal.org/docs/8/system-requirements/web-server) を参照してください。

---

開発者であれば [Webrick](https://docs.ruby-lang.org/ja/latest/library/webrick.html)(ruby)や [http.server](https://docs.python.org/ja/3/library/http.server.html)(python)のように、言語自体に組み込まれた軽量なWebサーバーで素早く環境を立ち上げたいと思うかもしれません。

Drupalは以下の2つの方法で、PHPのBuilt-in Webサーバーを使って起動することもできます。

- [Drupal 8 Quick Start Command](https://www.drupal.org/docs/8/install/drupal-8-quick-start-command)
- [Drupal Console: server](https://drupalconsole.com/docs/en/commands/server)

2つ目の [Drupal Console](https://github.com/hechoendrupal/drupal-console) を使う方法は、「Drupalのインストール」で紹介します。

---

### HTML, CSS, Javascript

HTML, CSS, Javascriptはどんな言語、フレームワークを使うかによらず、Webアプリケーションの開発で必須となる知識です。

Drupal 8.8時点のコアにおけるこれらの利用状況は、
- HTML: HTML5, WAI-ARIAに準拠
- CSS: Sass/LESSのようなプリプロセッサは利用されていない
- Javascript: jQuery, Backbone.js, underscore.js, modernizr.jsなどを利用し、独自のコードはES6で実装しBabelでコンパイルしている

といったところになります。

---

これらの要素に対してどこまでの知識が必要になるかは、利用するモジュールやテーマがどんなツールやライブラリに依存しているか、プロジェクトで採用する技術要素、開発ポリシーなどによって変わってきます。

理解が足りないと感じる場合は、必要に応じて外部のコンテンツを参照してください。

---

<!-- _class: lead -->
## Drupalのアーキテクチャ

---

### コア、モジュール、テーマ

Drupal 8コアについて説明する時、2つの方法で解釈できます。
- 狭義のコア: モジュールとテーマを除いたすべてのコードでカバーされる機能。つまり、[コード全体](https://github.com/drupal/drupal) から `modules`, `themes` ディレクトリを除いたもの
- 広義のコア: デフォルトのコードベース全体(つまり、モジュールとテーマを含む)

---

通常、 「それはコアの機能でできますか？」 のような会話をする場合、広義の意味で扱うことがほとんどです。

しかし、両者の違いを理解する事にはとても有益です。

なぜなら、後述するフックやイベントといったDrupalを拡張するためのインターフェースを使い、狭義のコアと広義のコアが連携しているためです。

この点を理解しておくと、コードリーディングやデバッグの大きな助けになります。

---

コアライブラリ(狭義のコア)は、Drupalプロジェクトに属する独自のコードと、Symfonyなどのオープンソースで公開されているPHPライブラリ群で構成されます。

Drupal 7以前はほぼ全てを独自に開発しており、「Drupal Island」と揶揄されることもありましたが、Drupal 8からはいわゆる「普通のアプローチ」で開発されています。

これにより、PHPの他のコミュニティの開発者や他の言語やフレームワークの開発者がDrupalを利用しやすい状況が生まれています。

---

#### コアライブラリ(狭義のコア)
コアライブラリ(狭義のコア)は、Drupal全体で使用される機能とサービスを提供します。

たとえば、データベースと通信するための抽象化レイヤー、ユーザーデータのサニタイズ、フォームの構築、データのエンコードなどのヘルパーが提供されます。

---

#### モジュール
モジュール（コアとコントリビューションの両方）は、実際のビジネスロジックのほとんどがカプセル化される場所です。有効にすると、機能を提供したり、既存の機能を拡張したりできます。

Drupalのインストール方法次第ですが、いくつかのコアモジュールには無効にできないものもあります。大部分のモジュールは、必要に応じて任意にインストールおよびアンインストールすることができます。

---

#### テーマ
テーマ（コアとコントリビューションの両方）はプレゼンテーションレイヤーで使用されます。

これらは、コンテンツとデータをユーザーにレンダリングできるHTMLテンプレートや、CSS・Javascript・組み込みイメージなどのアセット類を提供します。

テーマは他のテーマを拡張でき、レンダリングされる前にデータを処理するためのPHPロジックを含むこともできます。

---

### フック、プラグイン、イベント

先述したように、Drupalはコアライブラリがフックやプラグインを介してモジュールやテーマと連携することで、アプリケーションとしてのデフォルトの機能を提供したり、拡張できるようになっています。

つまり、Drupalに対して独自のビジネスロジックを追加したい場合は、これらを実装することになります。

---

#### フック

フック(hook)は、Drupalコアとモジュールが他のモジュールやテーマからデータを収集（またはレンダリング）できるようにする非常に典型的なDrupalの手続き型の概念です。

これにより、モジュールが新しい機能を提供したり、既存の機能を変更したりできます。 

---

具体的には、インストールされたモジュールとテーマをスキャンし、特定の命名命名規則(つまり、フックの実装)に従う関数を検索することにより、フックが実行されます。

これは、ほとんどの場合 `module_name_hook_name()` という形式です。

さらに、関数名の末尾に単語　`_alter` が付けられたalterフックもあります。alterフックではその名の通り、他のフックの実装が処理したデータをalter(変更)することができます。

フックの実装やサンプルに関しては3章で解説します。

---

OOPやデザインパターンの知識がある方であれば、これを `Passive Observer` パターンでキャプチャされたイベント処理に似ていると思うかもしれません。

このように、特定の実装やフレームワークに依存した考え方ではなく、抽象化して物事を把握することはとても重要です。

特定のイベントが発生すると、Drupalはモジュールがそのイベントに応答する機会を許可します。

---

#### プラグイン

Drupalの以前のバージョンでは、フックを実装して機能を拡張することがDrupal開発の最も重要な要素でした。

Drupal 8でも依然としてフックは重要ですが、プラグイン(Plugin)、イベント(event)という新しい概念が登場しています。

以前のバージョンでフックを利用していた実装の多くは、プラグインを利用する実装に変更されています。

Drupal 8のプラグインは、マネージャーによって集中化された特定のタスクおよび機能で使用される発見可能(discoverable)な一連の機能です。

プラグインの実装やサンプルに関しては3章で解説します。

---

#### イベント

Drupal 8で導入された3番目の拡張ポイントはイベントシステムです。ただし、フックやプラグインとは異なり、これはDrupal独自のものではなく、[Symfony EventDispatcher](http://symfony.com/doc/current/components/event_dispatcher.html) コンポーネントです。

イベントは主に、Drupalで特定のアクションまたはフローに介入して停止または変更するために使用されます。

過去にフックを介して処理されていた応答要求タスクの多くは、イベントをディスパッチして、例えばユーザーへの応答の配信に関心のあるモジュールがあるかどうかを確認することで処理されるようになりました。

---

### サービスとDIコンテナ

Drupal 8のもう1つのアーキテクチャ的に重要な要素は、[SymfonyのDependency injection](http://symfony.com/doc/current/components/dependency_injection.html)コンポーネントであり、具体的にはサービスコンテナーによって表されます。

このコンポーネントは、モダンなオブジェクト指向PHPプログラミングの主要部分であり、Drupal 8の基礎となっています。

これにより、特定の機能(および場合によっては切り替え可能な)タスクを処理するために、さまざまなコードに挿入できるサービスを作成できます。

---

また、サービスには拡張ポイントとして使用することもできます。これは、サービスには非常に特定の責任を持つサービスをグループ化し、そのサービスを自動的に使用できるためです。

つまり、単純なサービスを定義するだけで、機能を提供したり、既存のロジックを変更したりすることさえできます。

サービスの実装やサンプルに関しては3章で解説します。

---

### リクエストからレスポンスまでの流れ

Webアプリケーションの基本的な流れは、HTTPでリクエストを受けてHTTPでレスポンスを返すことです。

Drupal内部で、これらがどのように処理されるのかを簡単に説明していきます。

---

1.ユーザーがWebブラウザーでhttp://example.com/node/123 URLにアクセスします。

2.ブラウザーはexample.comのWebサーバーにアクセスし、リソース `/node/123` を要求します

3. Webサーバーは、リクエストをPHPで処理する必要があることを認識し、リクエストを処理するためにPHP環境を起動（または接続）します。

4. PHPはDrupalのフロントコントローラーファイル (`index.php`)を実行し、要求されたリソースから新しい `Request` オブジェクトを作成します。

---

5. symfonyのHTTPKernelは、`kernel.request`、 `kernel.controller`、`kernel.response`、`kernel.view` などの多数のイベントをディスパッチすることにより、このリクエストオブジェクトを処理します。
   
6.そのリクエストにマッピングされるルートは、`kernel.request` イベントによって識別されます。

7.ルートコントローラーが識別され、`kernel.controller` イベントを使用して、責任のあるコントローラーで変更を実行し、渡される必要のある引数を解決します。この場合、このルートはメインEntityシステムを介してNodeモジュールによって登録されます。メインEntityシステムは、エンティティIDを識別してロードし、応答の一部として返されるマークアップを構築します。

---