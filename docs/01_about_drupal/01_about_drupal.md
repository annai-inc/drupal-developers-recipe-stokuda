---
marp: true
theme: gaia
_class: invert
---

<!-- _class: lead -->
# 1.1 Drupalとは

---

Drupalは、Webベースのコンテンツ管理システム（CMS）です。

CMSとしてすぐに利用できるように基本的な機能が提供されていますが、機能を拡張する開発がしやすいことを念頭に置いて設計されています。

1章では、Drupal 8で開発を行うための用語、ツール、およびプロセスを紹介します。

2章以降ではコードの実装に焦点を当てますが、この章ではDrupalのアーキテクチャや概念に焦点を当てて説明します。

---

<!-- _class: lead -->
## 1.1.1 Drupalの概要

---

Drupalは伝統的なWebベースのCMSに必要な標準機能をすべて備えています。

- 訪問者はサイト上の公開情報の表示、メニューによるナビゲーション、リストの表示、個々のページの編集などを行うことができます
- ユーザーはアカウントを作成してコメントを残すことができます
- 管理者はサイトの設定やアカウントの権限の制御ができます
- 編集者はページを非公開で作成・プレビューし、準備ができたらコンテンツを公開することができます
- いくつかの組み込みテーマにより、サイトのデザインも簡単に変更できます

---

Drupal 8はこれらを改良し、より強力な機能をいくつか導入しました。

たとえば、高度な多言語サポート、コンテンツモデレーション、レイアウト構築、REST APIなどです。

Drupal 7では、このような機能はコアには含まれず外部のモジュールを利用する必要がありました。

Drupal 8では、これらの機能はコア自体に含まれています。その他にも多くの機能がすぐに使用できるようになりました。

---

<!-- _class: lead -->
## 1.1.2 Drupal 8での開発

---

Drupal 8はデフォルトでも多くの機能を提供しますが、全てのユーザーのニーズを満たすわけではありません。そのために、Drupalの機能はモジュール、テーマ、インストールプロファイルで拡張することができます。

[drupal.org](http://drupal.org) を見ると、数千以上の新しい機能を提供するモジュールや、サイトのデザインを変更するテーマを見つけることができます。

---

モジュールとテーマを利用してDrupalを拡張できる柔軟なアーキテクチャにより、Drupalは単なるCMSではなく「特定のニーズと機能要件に合わせて拡張できる `コンテンツ管理フレームワーク(CMF)` である」と言われるようになりました。

例えば、

- ユーザー認証のためにディレクトリサーバーを利用したい
- データをcsvでエクスポートしたい
- SNSへのシェアボタンを追加したい

などのニーズを、drupal.orgで公開されているモジュールを導入することで満たすことができます。

---

一方で、先のような一般的なニーズではなく、次のような特殊なビジネス要件を解決するためにDrupalをカスタマイズするにはどうすれば良いでしょうか？

- 自社で開発したプロプライエタリなシステムと連携したい
- ビジネス特有の業務プロセスを補助するためのワークフローを提供したい

おそらく、その問題を完璧に解決してくれるモジュールは存在しません。

その代わりに、少しのコードを書くことで問題を解決することができます。

---

本コンテンツの目的は「Drupal開発者のために必要な知識とツールを可能な限り迅速に提供すること」です。

本章を含め3章(予定)までを順に進めることで、Drupalの開発に必要な要素を順に理解していく形になっています。

4章以降(予定)では、特定の問題を解決するためのレシピ的なテクニックを紹介します。3章まで一旦読み終えてから、必要に応じて参照してください。

---

ほとんどのセクションでは、Drupalの機能や概念を理解するためのサンプルコードを提供します。

サンプルコードはDrupalのコーディング規約に従い、Drupalのデザインパターンを活用しているため、コードの断片には実際のプロダクト開発に流用できるものもたくさんあります (意味を理解せずにコピペで使うのはダメですよ！)。

それでは、Drupalをよりよく理解するために、いくつかの予備知識を学ぶことから始めましょう。

---

<!-- _class: lead -->
## 1.1.3 Drupalが利用するテクノロジー

---

### 1.1.3.1 PHP

Drupalは [PHP](https://www.php.net/) で実装されており、本コンテツ作成時点の最新バージョンであるDrupal 8.8では[PHP 7.2の利用が推奨されています](https://www.drupal.org/project/drupal/releases/8.8.0)。

[PHPのサポートサイクル](https://www.php.net/supported-versions.php) を意識しながら、ビジネスの要件に合わせて最適なバージョンを選択してください。

---

PHPに関してのDrupal 7からの非常に重要な変更は、オブジェクト指向のコードとデザインパターンの利用です。

残念ながら、まだ多くの手続き型の実装がDrupal 8のコードベース全体に残っていますが、Symfonyコンポーネントなど多くの優れた外部ライブラリを利用することで、Drupalのコードは非常にモダンになりました。

そのため、Drupal 8の開発を行う場合は、PHPに関連したオブジェクト指向プログラミングの基本的な知識や、デザインパターンの知識があることも非常に重要です。

（やんわり書いていますが、複雑なプロダクト開発や、特にコードリーディングの面では必須です。

---

Drupal 7以前で開発経験がある方は、コアの内部設計やコードの実装はほぼ置き換わっていることを念頭に置いておきましょう。

```txt
$ git clone https://github.com/drupal/drupal.git
$ cd drupal
$ git diff --stat origin/7.x...origin/8.0.x|tail -n 1
 13327 files changed, 1429223 insertions(+), 287597 deletions(-)
```

---

### 1.1.3.2 データベース

Drupal 8はいくつかの代表的なデータベースをサポートしています。
詳細は [Database server](https://www.drupal.org/docs/8/system-requirements/database-server) を参照してください。

Drupalコアがデータベースにアクセスする際は、PHP言語の抽象化レイヤーである[PDO](https://www.php.net/manual/en/book.pdo.php) を利用します。

開発者向けには[Dynamic Queries](https://www.drupal.org/docs/8/api/database-api/dynamic-queries) と呼ばれる抽象化されたAPIが提供されています。

このAPIについては2章で別途解説します。

---

他のモダンなフレームワークで開発する場合と同様に、Drupalの開発において直接SQLを書くケースはほぼありません。

(頻繁にあるようなら実装の妥当性を疑いましょう、99%必要ないはずです)

しかし、ある程度規模の大きいシステムになるとパフォーマンスのチューニング等が必要になるケースもあります。

そのため、基本的なSQL構文の理解や「このAPIを使うと内部的にはこんなSQLが実行されるはずだ」といった内部構造の把握と理解は、依然としてとても重要になります。

---

### 1.1.3.3 Webサーバー

DrupalはApache,nginx,IIS,Lighttpdなどの主要なWebサーバー上で動作します。

詳細は [Web Server](https://www.drupal.org/docs/8/system-requirements/web-server) を参照してください。

---

開発者であれば [Webrick](https://docs.ruby-lang.org/ja/latest/library/webrick.html)(ruby)や [http.server](https://docs.python.org/ja/3/library/http.server.html)(python)のように、言語自体に組み込まれた軽量なWebサーバーで素早く環境を立ち上げたいと思うかもしれません。

Drupalは以下の2つの方法で、PHPのBuilt-in Webサーバーを使って起動することもできます。

- [Drupal 8 Quick Start Command](https://www.drupal.org/docs/8/install/drupal-8-quick-start-command)
- [Drupal Console: server](https://drupalconsole.com/docs/en/commands/server)

2つ目の [Drupal Console](https://github.com/hechoendrupal/drupal-console) を使う方法は、1.5章「Drupalのインストール」で紹介します。

---

### 1.1.3.4 HTML, CSS, Javascript

HTML, CSS, Javascriptはどんな言語、フレームワークを使うかによらず、Webアプリケーションの開発で必須となる知識です。

Drupal 8.8時点のコアにおけるこれらの利用状況は、
- HTML: [HTML5](https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/HTML5), [WAI-ARIA](https://www.w3.org/TR/2019/WD-wai-aria-1.2-20191218/)に準拠
- CSS: Sass/LESSのようなCSSプリプロセッサは利用されていない
- Javascript: jQuery, Backbone.js, underscore.js, modernizr.jsなどを利用し、独自のコードはES6で実装して[Babel](https://babeljs.io/)でコンパイルしている

といったところになります。

---

これらの要素に対してどこまでの知識が必要になるかは、利用するモジュールやテーマがどんなツールやライブラリに依存しているか、プロジェクトで採用する技術要素、開発ポリシーなどによって変わってきます。

理解が不足していると感じる場合は、必要に応じて外部のコンテンツを参照してください。

---

<!-- _class: lead -->
## 1.1.4 Drupalのアーキテクチャ

---

### 1.1.4.1 コア、モジュール、テーマ

「Drupalのコア」という言葉を使う時、何を意味するかは2つの方法で解釈できます。

- 狭義のコア: モジュールとテーマを除いたすべてのコードでカバーされる機能。つまり、[コード全体](https://github.com/drupal/drupal) から `modules`, `themes` ディレクトリを除いたもの。`コアライブラリ` と呼ばれることもある。
- 広義のコア: デフォルトのコードベース全体(つまり、モジュールとテーマを含む)

---

「それはコアの機能でできますか？」 のような会話をする場合、広義の意味で扱うことがほとんどです。

しかし、両者の違いを理解する事はとても重要です。

なぜなら、後述するフックやプラグイン、イベントといったDrupalを拡張するためのインターフェースを使い、狭義のコアと広義のコアが連携しているためです。

この点を理解しておくと、コードリーディングやデバッグの大きな助けになります。

---

コアライブラリ(狭義のコア)は、Drupalプロジェクトに属する独自のコードと、Symfonyなどのオープンソースで公開されているPHPライブラリ群で構成されます。

Drupal 7以前はほぼ全てを独自に開発しており、「[Drupal Island](https://www.slideshare.net/webchickenator/drupal-8-a-story-of-growing-up-and-getting-off-the-island)」と揶揄されることもありましたが、Drupal 8からはいわゆる「[普通のアプローチ](https://en.wikipedia.org/wiki/Package_manager)」で開発されています。

これにより、PHPの他のコミュニティの開発者や他の言語やフレームワークの開発者がDrupalを利用しやすい状況が生まれています。

---

#### 1.1.4.2 コアライブラリ(狭義のコア)

コアライブラリ(狭義のコア)は、Drupal全体で使用される機能とサービスを提供します。

たとえば、データベースと通信するための抽象化レイヤー、ユーザーデータのサニタイズ、フォームの構築、データのエンコードなどのヘルパーが提供されます。

---

#### 1.1.4.3 モジュール

モジュール（コアとコントリビューションの両方）は、実際のビジネスロジックのほとんどがカプセル化される場所です。有効にすると、新しい機能を提供したり既存の機能を拡張したりできます。

Drupalのインストール方法次第ですが、いくつかのコアモジュールには無効にできないものもあります。

しかし、大部分のモジュールは必要に応じて任意にインストールおよびアンインストールすることができます。

---

#### 1.1.4.4 テーマ

テーマ（コアとコントリビューションの両方）はプレゼンテーションレイヤーで使用されます。

これらはコンテンツやデータをユーザーがレンダリングするためのHTMLテンプレートや、CSS・Javascript・組み込みイメージなどのアセットを提供します。

テーマは他のテーマを拡張でき、レンダリングされる前にデータを処理するためのPHPロジックを含むこともできます。

---

### 1.1.4.5 フック、プラグイン、イベント

先述したように、Drupalはコアライブラリがフックやプラグイン、イベントを介してモジュールやテーマと連携することで、アプリケーションとしての機能を提供したり、拡張できるようになっています。

つまり、Drupalに対して独自のビジネスロジックを追加したい場合は、これらを実装することになります。

---

#### 1.1.4.6 フック

フック(hook)は、Drupalコアとモジュールが他のモジュールやテーマからデータを取得（またはレンダリング）できるようにする、非常に典型的なDrupalの手続き型の概念です。

これにより、モジュールが新しい機能を提供したり、既存の機能を変更したりできます。 

---

具体的には、インストールされたモジュールとテーマをスキャンし、特定の命名規則に従う関数(つまりフックの実装)を検索することにより、フックが実行されます。

これは、ほとんどの場合 `module_name_hook_name()` という形式です。

さらに、関数名の末尾に単語　`_alter` が付けられたalterフックもあります。alterフックではその名の通り、他のフックの実装がデータを処理した後に更にデータをalter(変更)することができます。

フックの実装に関しては2章で解説します。

---

OOPやデザインパターンの知識がある方であれば、これを [Passive Observer](https://codeburst.io/observer-pattern-object-oriented-php-4e669431bcb9) パターンのイベント処理に似ていると思うかもしれません(実際、概念としてはその通りです)。

このように、特定の実装やフレームワークに依存した考え方ではなく、抽象化して物事を把握することはとても重要です。

つまり、特定のイベントが発生すると、Drupalはモジュールやテーマがそのイベントに応答する機会を提供します。

---

#### 1.1.4.7 プラグイン

Drupalの以前のバージョンでは、フックを実装して機能を拡張することがDrupal開発の最も重要な要素でした。

Drupal 8でも依然としてフックは重要ですが、プラグイン(Plugin)、イベント(event)という新しい概念が登場しています。

以前のバージョンでフックを利用していた実装の多くは、プラグインを利用する実装に変更されています。

Drupal 8のプラグインは、マネージャーによって集中化された特定のタスクおよび機能で使用される発見可能(discoverable)な一連の機能です。

プラグインの実装に関しては2章で解説します。

---

#### 1.1.4.8 イベント

Drupal 8で導入された3番目の拡張ポイントはイベントシステムです。

ただし、フックやプラグインとは異なり、これはDrupal独自のものではなく、[Symfony EventDispatcher](http://symfony.com/doc/current/components/event_dispatcher.html) コンポーネントそのものです。

イベントは主に、Drupalで特定のアクションまたはフローに介入して停止または変更するために使用されます。

過去にフックを介して処理されていたタスクの多くは、イベントをディスパッチして、例えばユーザーへの応答の配信に関心のあるモジュールがあるかどうかを確認することで処理されるようになりました。

---

### 1.1.4.9 サービスとDIコンテナ

Drupal 8のもう1つのアーキテクチャ的に重要な要素は、[SymfonyのDependency injection](http://symfony.com/doc/current/components/dependency_injection.html)コンポーネントであり、具体的にはサービスコンテナーの利用です。

このコンポーネントは、モダンなオブジェクト指向PHPプログラミングの主要部分であり、Drupal 8の基盤となっています。

サービスは「同じインターフェースをサポートする切替可能な機能の集合」です。

サービスを作成することで、特定のタスクを処理するために複数のサービスを切り替えて利用するようなことができます。

---

つまり、単純なサービスを定義するだけで、機能を提供したり、既存のロジックを変更したりすることもできます。

サービスの実装に関しては2章で解説します。

---

### 1.1.5 リクエストからレスポンスまでの流れ

Webアプリケーションの基本的な流れは、HTTPでリクエストを受けてHTTPでレスポンスを返すことです(必ずしもHTMLを返すわけではない点に注意してください)。

Drupal内部で、これらがどのように処理されるのかを簡単に説明していきます。

---

1.ユーザーがWebブラウザで http://example.com/node/123 にアクセスします。

2.ブラウザはexample.comのWebサーバーにアクセスし、リソース `/node/123` を要求します

3. WebサーバーはリクエストをPHPで処理する必要があることを認識し、リクエストを処理するためにPHPを起動（または接続）します。

---

4. PHPはDrupalのフロントコントローラーファイル (`index.php`)を実行し、HTTPリクエストを元に [Request](https://symfony.com/doc/current/components/http_foundation.html#request) オブジェクトを作成します。

5. Symfonyの [HTTPKernelコンポーネント](https://symfony.com/doc/current/components/http_kernel.html) は、`kernel.request`、 `kernel.controller`、`kernel.response`、`kernel.view` などの多数のイベントをディスパッチすることにより、このリクエストオブジェクトを処理します。
   
6. リクエストにマッピングされるルート、つまり処理を担当する機能は `kernel.request` イベントによって識別されます。

---

7. `kernel.controller` イベントに対して応答の責任があるコントローラーが処理を実行し、レスポンスとなるデータを生成します。この例では、ルートはEntityシステムを介してnodeモジュールによって処理されます。EntityシステムはエンティティIDを識別してロードし、応答の一部として返されるマークアップを構築します。

---

8. それぞれのコントローラー（またはハンドラー）は、[Response](https://symfony.com/doc/current/components/http_foundation.html#response) オブジェクトまたはレスポンスを生成するためのメタデータを含むレンダリング配列([Render Array](drupal.org/docs/8/api/render-api/render-arrays))を返します。レンダリング配列は、最終的にはThemeレイヤーでHTMLに変換されます。

9. 応答が作成されると、フロントコントローラーはそれをブラウザーに返して処理を終了します。

---

全体のシーケンスについては、[The Drupal 8 render pipeline](https://www.drupal.org/docs/8/api/render-api/the-drupal-8-render-pipeline) で非常に詳しく解説されているので参考にしてください。

---

## まとめ

このセクションではDrupalの概要について解説しました。

フック、プラグインなど、個別の要素に対する詳細な解説は2章で行います。
